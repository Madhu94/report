### Pre-processing
#### Batch Jobs
Aggreation queries that involve processing millions of records and take several seconds to complete can be set up as batch jobs if they are known in advance. A separate collection can be used for maintaining the state between the aggregation operations. For this, MongoDB's bulk unordered upsert function can be used or, since the results are likely to be queried together, they can be stored as one document. In this case, maintaining state of the aggregation within that single document might be best.

#### MongoDB's Oplog
The oplog is used by the primary in a replica set to maintain a log of the operations it has performed on its data. This oplog is used by the secondaries to replicate the changes to its data. The entries in the oplog are idempotent,i.e. replaying the contents of the log any number of times should get us the same result.MongoDB's oplog is a capped collection in the local database on each shard. Capped collections are fixed in size - when it runs out of space it overwrites the oldest data.Capped collections can have a tailable cursor. A tailable cursor does not close when it reaches the end of the data, but can be polled later to get back any data inserted in the meantime. Using a tailable cursor we can query the oplog at regular intervals. This interval should be less than the oplog time - the time taken for the oplog to fill up. By tailing the oplog and parsing the results we can build a system that updates in real time, the results for certain queries.